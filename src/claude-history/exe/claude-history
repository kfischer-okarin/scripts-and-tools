#!/usr/bin/env ruby
# frozen_string_literal: true

require_relative "../lib/claude_history"
require "thor"

module ClaudeHistory
  class CLI < Thor
    PROJECTS_PATH = File.expand_path("~/.claude/projects")

    desc "projects", "List all projects with last updated timestamp"
    def projects
      history = History.new(PROJECTS_PATH)
      sorted = history.projects.sort_by { |p| p.last_updated_at || Time.at(0) }.reverse

      print_projects_table(sorted)
    end

    desc "sessions", "List all sessions in a project"
    method_option :project, type: :string, required: true, desc: "Project ID"
    method_option :limit, type: :numeric, default: 20, desc: "Number of sessions to show"
    method_option :all_threads, type: :boolean, default: false, desc: "Show all threads per session"
    def sessions
      history = History.new(PROJECTS_PATH)
      all_sessions = history.sessions(project_id: options[:project])
      sessions_list = all_sessions.first(options[:limit])

      print_sessions_table(sessions_list, total: all_sessions.size, show_threads: options[:all_threads])
    end

    private

    def print_projects_table(projects)
      return puts "No projects found." if projects.empty?

      # Calculate column widths
      id_width = [projects.map { |p| p.id.length }.max, "PROJECT ID".length].max
      time_width = ["LAST UPDATED AT".length, "2025-12-23 00:07:04".length].max

      # Print header
      puts format("%-#{id_width}s  %-#{time_width}s", "PROJECT ID", "LAST UPDATED AT")
      puts "-" * (id_width + 2 + time_width)

      # Print rows
      projects.each do |project|
        timestamp = project.last_updated_at&.getlocal&.strftime("%Y-%m-%d %H:%M:%S") || "N/A"
        puts format("%-#{id_width}s  %-#{time_width}s", project.id, timestamp)
      end
    end

    def print_sessions_table(sessions, total:, show_threads:)
      return puts "No sessions found." if sessions.empty?

      puts "Showing #{sessions.size} of #{total} sessions"
      puts "Tip: Use --all-threads to show individual conversation threads" unless show_threads
      puts

      # Calculate column widths (8 chars + "..." = 11)
      id_width = 11
      thread_prefix = "  └─ "
      col_width = show_threads ? id_width + thread_prefix.length : id_width
      time_width = "2025-12-23 00:07:04".length
      summary_width = 50

      # Print header
      puts format("%-#{col_width}s  %-#{summary_width}s  %s", "SESSION ID", "SUMMARY", "LAST UPDATED AT")

      # Print rows
      sessions.each do |session|
        timestamp = session.last_updated_at&.getlocal&.strftime("%Y-%m-%d %H:%M:%S") || "N/A"
        summary = truncate_summary(session.threads.first&.summary, summary_width)
        puts format("%-#{col_width}s  %-#{summary_width}s  %s", green(truncate_id(session.id)), summary, grey(timestamp))

        next unless show_threads

        session.threads.each do |thread|
          thread_timestamp = thread.last_updated_at&.getlocal&.strftime("%Y-%m-%d %H:%M:%S") || "N/A"
          thread_summary = truncate_summary(thread.summary, summary_width)
          puts format("#{thread_prefix}%-#{id_width}s  %-#{summary_width}s  %s", green(truncate_id(thread.id)), thread_summary, grey(thread_timestamp))
        end
      end
    end

    def truncate_summary(text, max_length)
      return "" if text.nil? || text.empty?

      first_line = text.lines.first&.strip || ""
      first_line.length > max_length ? first_line[0...max_length - 3] + "..." : first_line
    end

    def truncate_id(id, length = 8)
      id.length > length ? "#{id[0, length]}..." : id
    end

    def green(text)
      "\e[32m#{text}\e[0m"
    end

    def grey(text)
      "\e[90m#{text}\e[0m"
    end
  end
end

ClaudeHistory::CLI.start(ARGV)
